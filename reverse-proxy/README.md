# ReverseProxy
- í´ë¼ì´ì–¸íŠ¸ì˜ ìš”ì²­ì„ ì„œë²„ë¡œ ì „ë‹¬í•˜ê³ , ì„œë²„ì˜ ì‘ë‹µì„ í´ë¼ì´ì–¸íŠ¸ë¡œ ì „ë‹¬í•˜ëŠ” ì¤‘ê³„ ì—­í• ì„ í•˜ëŠ” ì„œë²„ì…ë‹ˆë‹¤.
- ì¼ë°˜ì ìœ¼ë¡œ, Reverse ProxyëŠ” ì„œë²„ ì•ë‹¨ì— ìœ„ì¹˜í•˜ì—¬ ì—¬ëŸ¬ ê°€ì§€ ì¤‘ìš”í•œ ê¸°ëŠ¥ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.


### ì£¼ìš” ê¸°ëŠ¥
  - ë¡œë“œ ë°¸ëŸ°ì‹± (Load Balancing)
    -   ì—¬ëŸ¬ ëŒ€ì˜ ì„œë²„ë¡œ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ì„ ë¶„ë°°í•˜ì—¬ ê° ì„œë²„ì˜ ë¶€í•˜ë¥¼ ê³ ë¥´ê²Œ ë¶„ì‚°ì‹œí‚µë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì„œë²„ ê³¼ë¶€í•˜ë¥¼ ë°©ì§€í•˜ê³ , ì„œë¹„ìŠ¤ì˜ ê°€ìš©ì„±ê³¼ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      - ê¸°ë³¸ì ìœ¼ë¡œ Nginxì˜ Load Balancing ì„¤ì •ì€ ë¼ìš´ë“œ ë¡œë¹ˆì´ë‹¤.
    - ë¡œë“œ ë°¸ëŸ°ì‹± ì•Œê³ ë¦¬ì¦˜ì€ ë¼ìš´ë“œ ë¡œë¹ˆ(Round Robin), ìµœì†Œ ì—°ê²° ìˆ˜(Least Connections), í•´ì‹œ(Hash) ë“±ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - ë³´ì•ˆ ê°•í™”
    -  ì ‘ì ì¸ ì„œë²„ ë…¸ì¶œì„ ë§‰ì•„ ë³´ì•ˆì„ ê°•í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      -  ì„œë²„ì˜ IP ì£¼ì†Œì™€ êµ¬ì„± ì •ë³´ê°€ ì™¸ë¶€ì— ë…¸ì¶œë˜ì§€ ì•Šë„ë¡ ë³´í˜¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - ìºì‹± (Caching)
    -  ìì£¼ ìš”ì²­ë˜ëŠ” ì½˜í…ì¸ ë¥¼ ìºì‹±í•˜ì—¬, ë™ì¼í•œ ìš”ì²­ì´ ë“¤ì–´ì˜¬ ë•Œ ë°±ì—”ë“œ ì„œë²„ì— ë„ë‹¬í•˜ì§€ ì•Šê³  ë¹ ë¥´ê²Œ ì‘ë‹µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      - ì„œë²„ ì„±ëŠ¥ ê°œì„  ë° ì‘ë‹µ ì‹œê°„ ë‹¨ì¶• ê°€ëŠ¥

### ì‘ë™ ë°©ì‹
- í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ì‚¬ì´ì—ì„œ ì¤‘ê°œì ì—­í• ì„ í•©ë‹ˆë‹¤.
- íë¦„
  - 1 . í´ë¼ì´ì–¸íŠ¸ëŠ” Reverse Proxyë¥¼ ì„œë²„ë¡œ ì¸ì‹í•˜ê³  ìš”ì²­ì„ ë³´ëƒ„
  - 2 . Reverse ProxyëŠ” í•´ë‹¹ ìš”ì²­ì„ ì ì ˆí•œ ë°±ì—”ë“œ ì„œë²„ë¡œ ì „ë‹¬í•˜ê³ , ì„œë²„ë¡œë¶€í„° ì‘ë‹µì„ ë°›ì€ í›„ ì´ë¥¼ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ë°˜í™˜
  - ex) `[Client] â†’ [Reverse Proxy] â†’ [Backend Server(s)]`

  
### ì˜ˆì œ ì½”ë“œ

- #### Nginx
  - Dockerë¥¼ ì‚¬ìš© í•˜ì—¬ êµ¬ë™í•˜ì˜€ë‹¤.
  - ì„¤ì •ì€ `nginx.conf` ë‚´ì—ì„œ ì‚¬ìš©í•œë‹¤.
  - Docker-compose
    ```yaml
    # docker-compose.yml
    
    version: '3'
    services:
      nginx:
        image: nginx:latest
        container_name: reverse-proxy
        ports:
          - "80:80"
        # Volumes ì„¤ì •ì„ í†µí•´ nginx.conf ì„¤ì •ì„ ë™ê¸°í™” ì‹œí‚´
        volumes:
          - ./nginx.conf:/etc/nginx/nginx.conf
    ```
  - nginx.conf
    - ì£¼ì˜ ì‚¬í•­ì€ Docker-composeë¥¼ ì‚¬ìš©í•´ì„œ êµ¬ë™í•˜ì˜€ê¸°ì— ì—°ê²°í•˜ë ¤ëŠ” upstream(ì„œë²„ë“¤)ì˜ ì£¼ì†ŒëŠ” **í˜¸ìŠ¤íŠ¸ ì„œë²„ì˜ ì£¼ì†Œ** ë˜ëŠ” **Docker-Network** ì£¼ì†Œí•´ì•¼í•œë‹¤.
    ```yaml
    # /etc/nginx/nginx.conf
    
    # ì „ì—­ ì»¨í…ìŠ¤íŠ¸
    user nginx;  # Nginxê°€ ì‹¤í–‰ë˜ëŠ” ì‚¬ìš©ì
    worker_processes auto;  # ìë™ìœ¼ë¡œ ì›Œì»¤ í”„ë¡œì„¸ìŠ¤ ìˆ˜ë¥¼ ì„¤ì •
    pid /run/nginx.pid;  # PID íŒŒì¼ì˜ ìœ„ì¹˜
    
    events {
        worker_connections 1024;  # ìµœëŒ€ ì—°ê²° ìˆ˜ ì„¤ì •
    }
    
    # HTTP ì»¨í…ìŠ¤íŠ¸
    http {
        # â„¹ï¸ ì›í•œë‹¤ë©´ ì•„ë˜ì— ë¡œë“œë°¸ëŸ°ì‹±ì— ì‚¬ìš©ë  ë©”ì„œë“œë¥¼ ì§€ì • ê°€ëŠ¥
        ## {Load Balancing Method} # ë¡œë“œ ë°¸ëŸ°ì‹± ë©”ì„œë“œ ì§€ì • ex) ip_hash;
    
        # Upstream ë¸”ë¡
        upstream backend {
            ## â„¹ï¸ localhostë¡œ ì ‘ê·¼í•˜ë©´ 127.0.0.1ë¡œ ì ‘ê·¼í•œë‹¤ í•˜ì§€ë§Œ Dockerë¥¼ ì‚¬ìš©í–ˆê¸°ì— ê·¸ëŸ¬í•¨
            server 192.168.1.45:8081;  # ì²« ë²ˆì§¸ ë°±ì—”ë“œ ì„œë²„
            server 192.168.1.45:8082;  # ë‘ ë²ˆì§¸ ë°±ì—”ë“œ ì„œë²„
        }
    
        # ì„œë²„ ë¸”ë¡
        server {
            listen 80;  # ì´ ì„œë²„ê°€ ìš”ì²­ì„ ìˆ˜ì‹ í•˜ëŠ” í¬íŠ¸
    
            # ìœ„ì¹˜ ë¸”ë¡
            location / {
                proxy_pass http://backend;  # 'backend' ì—…ìŠ¤íŠ¸ë¦¼ ê·¸ë£¹ìœ¼ë¡œ ìš”ì²­ ì „ë‹¬
            }
        }
    }
    ```

- #### Servers(2ê°œ ì ìš©)
  - ê°„ë‹¨í•˜ê²Œ ìš”ì²­ -> í•´ë‹¹ í¬íŠ¸ë¥¼ ì‘ë‹µí•˜ëŠ” ì„œë²„ë¥¼ êµ¬ì„±
    - â„¹ï¸ í•´ë‹¹ ì„œë²„ì˜ ë„ë©”ì¸ ì •ë³´ë¥¼ í™•ì¸í•˜ëŠ” ì½”ë“œë¥¼ í™•ì¸í•´ë³´ë‹ˆ `upstream`ì—ì„œ ì§€ì •í•œ ì£¼ì†Œë¡œ ë°˜í™˜ì„ í™•ì¸ `upstream {{ì§€ì •ëª…}}`
      - í•˜ë‹¨ `proxy_pass http://backend;`ê°€ ì‹¤ì§ˆì ìœ¼ë¡œ passí•˜ëŠ” ë¶€ë¶„ì´ê¸´í•¨
  - Controller
    ```java
    @RestController
    @RequestMapping("/api")
    public class ApiController {
        @Value("${server.port}")
        private Integer port;
        @GetMapping
        public String greeting() {
            /**
             * â„¹ï¸ ì˜ˆìƒ Log
             * "This domain is ::: " + 192.168.1.45:8081
             *
             * ğŸ‘‰ ê²°ê³¼
             * This domain is ::: http://backend
             * */
            return "This domain is ::: " + ServletUriComponentsBuilder.fromCurrentContextPath().toUriString()
                    + " /// Port is ::: " + port;
        }
    }
    ```
  


